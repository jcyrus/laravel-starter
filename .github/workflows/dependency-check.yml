name: Weekly Dependency Check

on:
  schedule:
    # Runs every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allows manual trigger from GitHub UI

jobs:
  check-dependencies:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite
          coverage: none

      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-interaction --no-progress

      - name: Check for outdated packages
        id: outdated
        run: |
          echo "Checking for outdated packages..."
          
          # Run composer outdated and capture output
          if composer outdated --direct --format=json > outdated.json 2>&1; then
            OUTDATED_COUNT=$(jq '.installed | length' outdated.json)
          else
            # If command fails, try without format flag
            composer outdated --direct > outdated.txt 2>&1 || true
            OUTDATED_COUNT=$(grep -c "^" outdated.txt || echo "0")
          fi
          
          # Check if there are any outdated packages
          if [ "$OUTDATED_COUNT" -gt 0 ]; then
            echo "has_outdated=true" >> $GITHUB_OUTPUT
            echo "Found $OUTDATED_COUNT outdated package(s)"
            
            # Generate human-readable report
            echo "## üì¶ Outdated Packages Report" > report.md
            echo "" >> report.md
            echo "**Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> report.md
            echo "" >> report.md
            echo "\`\`\`" >> report.md
            composer outdated --direct >> report.md 2>&1 || true
            echo "\`\`\`" >> report.md
            echo "" >> report.md
            echo "---" >> report.md
            echo "" >> report.md
            echo "To update packages, run:" >> report.md
            echo "\`\`\`bash" >> report.md
            echo "composer update" >> report.md
            echo "\`\`\`" >> report.md
          else
            echo "has_outdated=false" >> $GITHUB_OUTPUT
            echo "All packages are up to date! ‚úÖ"
          fi

      - name: Send email notification
        if: steps.outdated.outputs.has_outdated == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: '‚ö†Ô∏è Laravel Starter Kit: Outdated Dependencies Detected'
          to: ${{ secrets.MAIL_TO }}
          from: ${{ secrets.MAIL_FROM }}
          body: file://report.md
          content_type: text/markdown
          convert_markdown: true

      - name: Create issue if packages are outdated
        if: steps.outdated.outputs.has_outdated == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('report.md', 'utf8');
            
            // Check if there's already an open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'dependencies'
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes('Outdated Dependencies')
            );
            
            if (existingIssue) {
              // Update existing issue with new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## Updated Report (${new Date().toISOString().split('T')[0]})\n\n${report}`
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '‚ö†Ô∏è Outdated Dependencies Detected',
                body: report,
                labels: ['dependencies', 'maintenance']
              });
              console.log('Created new issue for outdated dependencies');
            }

      - name: Success notification
        if: steps.outdated.outputs.has_outdated == 'false'
        run: |
          echo "‚úÖ All dependencies are up to date!"
          echo "No action required."
